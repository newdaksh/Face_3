<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AI Face Recognition System</title>
    <link rel="stylesheet" href="/static/style.css" />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <!-- Header -->
    <header class="header">
      <div class="header-content">
        <div class="logo">
          <i class="fas fa-search"></i>
          <h1>AI Face Recognition âš¡</h1>
        </div>
        <!-- <div class="subtitle">Advanced Neural Network Face Matching System</div> -->
      </div>
    </header>

    <!-- Main Content -->
    <main class="main-container">
      <!-- Upload Section (two-column: Selfie | Upload) -->
      <section class="upload-section">
        <div class="upload-card two-column">
          <div class="option-column selfie-column">
            <div class="card-header">
              <i class="fas fa-camera-retro"></i>
              <h2>Click a Selfie</h2>
              <p>Take a live photo using your device camera</p>
            </div>
            <div class="selfie-action">
              <button type="button" id="selfieBtnBig" class="selfie-big-btn">
                <i class="fas fa-camera"></i>
                <span>Open Camera</span>
              </button>
              <div class="selfie-note">Allow camera access when prompted.</div>
            </div>
            <!-- Selfie Preview Area is removed, will use shared preview -->
          </div>

          <div class="option-column upload-column">
            <div class="card-header">
              <i class="fas fa-cloud-upload-alt"></i>
              <h2>Upload an Image</h2>
              <p>Select a face image to find similar matches in our database</p>
            </div>

            <form
              id="searchForm"
              action="/search"
              method="post"
              enctype="multipart/form-data"
            >
              <input type="hidden" name="top_k" id="topKHidden" value="20" />
              <input
                type="hidden"
                name="threshold"
                id="thresholdHidden"
                value="0.4"
              />

              <div class="upload-area">
                <input
                  type="file"
                  name="query_image"
                  id="queryImage"
                  accept="image/*"
                  required
                />
                <label for="queryImage" class="upload-label">
                  <div class="upload-content">
                    <i class="fas fa-image upload-icon"></i>
                    <span class="upload-text">Click to select image</span>
                    <span class="upload-subtext"
                      >PNG, JPG, JPEG up to 10MB</span
                    >
                  </div>
                </label>

                <!-- Preview Area is moved out -->
              </div>
            </form>
          </div>
        </div>

        <!-- Shared Preview Area for both Selfie and Upload -->
        <div id="previewArea" class="preview-area shared-preview hidden">
          <div class="preview-image-wrap">
            <img id="previewImage" src="" alt="Preview" />
            <div class="preview-overlay">
              <button type="button" class="btn-change" onclick="changeImage()">
                Change Image
              </button>
            </div>
          </div>
          <div class="preview-meta">
            <div id="previewFilename" class="preview-filename"></div>

            <!-- Controls that appear only after preview is shown -->
            <div id="previewControls" class="preview-controls hidden">
              <label for="topKUI">Max results:</label>
              <input id="topKUI" type="number" min="1" max="200" value="20" />

              <label for="thresholdUI">Similarity threshold (0-1):</label>
              <div class="threshold-row">
                <input
                  id="thresholdUI"
                  type="range"
                  min="0"
                  max="1"
                  step="0.01"
                  value="0.55"
                />
                <input
                  id="thresholdVal"
                  type="number"
                  min="0"
                  max="1"
                  step="0.01"
                  value="0.40"
                  title="Set similarity threshold value"
                  placeholder="e.g. 0.40"
                  class="threshold-input"
                />
              </div>
            </div>
          </div>
        </div>

        <!-- shared action button spanning both columns -->
        <div
          class="shared-action"
          style="grid-column: 1 / -1; margin-top: 1rem"
        >
          <button type="button" class="search-btn" id="searchBtn" disabled>
            <i class="fas fa-search"></i>
            <span>Search PHOTOS</span>
            <div class="loading-spinner hidden" aria-hidden="true"></div>
          </button>
        </div>
      </section>

      <!-- Query Preview Section -->
      {% if query_image %}
      <section class="query-section">
        <div class="query-card">
          <h3><i class="fas fa-eye"></i> Query Image</h3>
          <div class="query-preview">
            <img src="{{ query_image }}" alt="Query image" />
          </div>
        </div>
      </section>
      {% endif %}

      <!-- Results Section -->
      {% if results is not none %}
      <section class="results-section">
        <div class="results-header">
          <h2><i class="fas fa-images"></i> Search Results</h2>
          <div class="results-count">{{ results|length }} matches found</div>
          <div class="download-actions">
            <button type="button" id="downloadAllBtn" class="btn hidden">
              <i class="fas fa-download"></i> Download All Images (ZIP)
            </button>
          </div>
        </div>

        {% if results %}
        <div class="results-grid">
          {% for r in results %}
          <div
            class="result-card"
            data-path="{{ r.path|default('') }}"
            data-file="{{ r.file|e }}"
            data-score="{{ '%.3f'|format(r.score) }}"
          >
            {% if r.path %}
            <div class="result-image-container">
              <img src="{{ r.path }}" alt="{{ r.file }}" loading="lazy" />
              <div class="result-overlay">
                <i class="fas fa-expand-alt"></i>
                <!-- <span>Click to enlarge</span> -->
              </div>
            </div>
            {% else %}
            <div class="result-placeholder">
              <i class="fas fa-image-slash"></i>
              <span>Image not found</span>
            </div>
            {% endif %}
            <div class="result-info">
              <div class="filename">{{ r.file }}</div>
              <div class="score">
                <i class="fas fa-percentage"></i>
                {{ '%.1f'|format(r.score * 100) }}% match
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
        {% else %}
        <div class="no-results">
          <i class="fas fa-search-minus"></i>
          <h3>No matches found</h3>
          <p>Try adjusting your search criteria or upload a different image</p>
        </div>
        {% endif %}
      </section>
      {% endif %}
    </main>

    <!-- Modal for enlarged images -->
    <div id="imageModal" class="modal">
      <div class="modal-content">
        <span class="modal-close" onclick="closeModal()">&times;</span>
        <img id="modalImage" src="" alt="" />
        <div class="modal-info">
          <h3 id="modalFilename"></h3>
          <div id="modalScore"></div>
        </div>
      </div>
    </div>

    <!-- Camera Modal for selfie capture -->
    <div id="cameraModal" class="modal hidden">
      <div class="modal-content camera-content">
        <span class="modal-close" id="cameraClose">&times;</span>
        <h3>Take a Selfie</h3>
        <video
          id="cameraVideo"
          class="camera-media"
          autoplay
          playsinline
        ></video>
        <canvas id="cameraCanvas" class="camera-media hidden"></canvas>
        <div class="camera-actions">
          <button type="button" id="captureBtn" class="btn">Capture</button>
          <button type="button" id="retakeBtn" class="btn hidden">
            Retake
          </button>
          <button type="button" id="useBtn" class="btn hidden">
            Use Photo
          </button>
        </div>
      </div>
    </div>

    <!-- JavaScript -->
    <script>
      // Image preview functionality
      const uploadInput = document.getElementById("queryImage");
      const uploadLabel = document.querySelector(".upload-label");

      function disableUpload(disabled) {
        if (!uploadInput) return;
        uploadInput.disabled = disabled;
        if (uploadLabel) {
          uploadLabel.classList.toggle("disabled-label", disabled);
        }
      }

      function disableSelfie(disabled) {
        if (selfieBtnBig) selfieBtnBig.disabled = disabled;
        if (selfieBtnBig)
          selfieBtnBig.classList.toggle("disabled-btn", disabled);
      }

      document
        .getElementById("queryImage")
        .addEventListener("change", function (e) {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = function (ev) {
              document.getElementById("previewImage").src = ev.target.result;
              document.getElementById("previewArea").classList.remove("hidden");
              document.querySelector(".upload-label").style.display = "none";
              document.getElementById("searchBtn").disabled = false;
              // show preview-only controls (top_k, threshold)
              const controls = document.getElementById("previewControls");
              if (controls) controls.classList.remove("hidden");
              // enable download-all button when results present later
              // disable selfie controls when a file upload is chosen
              disableSelfie(true);
              // show filename
              const nameEl = document.getElementById("previewFilename");
              if (nameEl) {
                nameEl.textContent = file.name;
                nameEl.title = file.name;
              }
              // make preview image clickable to enlarge
              const previewImg = document.getElementById("previewImage");
              if (previewImg) {
                previewImg.addEventListener("click", function () {
                  openModal(ev.target.result, file.name, NaN);
                });
              }
            };
            reader.readAsDataURL(file);
            // When a file is uploaded, clear any existing selfie preview
            clearSelfie();
          }
        });

      function changeImage() {
        document.getElementById("queryImage").value = "";
        document.getElementById("previewArea").classList.add("hidden");
        document.querySelector(".upload-label").style.display = "flex";
        document.getElementById("searchBtn").disabled = true;
        document.getElementById("previewImage").src = "";
        const nameEl = document.getElementById("previewFilename");
        if (nameEl) nameEl.textContent = "";
        // re-enable selfie controls when uploaded image is removed
        disableSelfie(false);
        // also re-enable upload if it was disabled by a selfie
        disableUpload(false);
        // hide preview-only controls
        const controls = document.getElementById("previewControls");
        if (controls) controls.classList.add("hidden");
      }

      // Form submission with loading state
      const searchForm = document.getElementById("searchForm");
      const sharedSearchBtn = document.getElementById("searchBtn");

      // Handle form submit (from either built-in submit or shared button)
      if (searchForm) {
        searchForm.addEventListener("submit", function (evt) {
          // If user has a selfie preview but hasn't populated the upload input,
          // populate it now from the last capture so the server receives the file.
          try {
            const input = document.getElementById("queryImage");
            if (
              input &&
              input.files.length === 0 &&
              cameraCanvas &&
              cameraCanvas.dataset &&
              cameraCanvas.dataset.lastCapture
            ) {
              const dataUrl = cameraCanvas.dataset.lastCapture;
              const file = dataURLToFile(dataUrl, "selfie.jpg");
              const dt = new DataTransfer();
              dt.items.add(file);
              input.files = dt.files;
              // trigger change so preview shows if needed
              const ev = new Event("change", { bubbles: true });
              input.dispatchEvent(ev);
            }
          } catch (e) {
            console.warn(
              "Failed to attach selfie to upload input before submit",
              e
            );
          }

          const btn = sharedSearchBtn;
          const spinner = btn.querySelector(".loading-spinner");
          const text = btn.querySelector("span");

          btn.disabled = true;
          if (spinner) spinner.classList.remove("hidden");
          if (text) text.textContent = "Searching...";
        });
      }

      // Wire shared button to submit the form
      if (sharedSearchBtn && searchForm) {
        sharedSearchBtn.addEventListener("click", function () {
          if (!sharedSearchBtn.disabled) {
            searchForm.requestSubmit();
          }
        });
      }

      // Sync UI controls to hidden form inputs
      const topKUI = document.getElementById("topKUI");
      const thresholdUI = document.getElementById("thresholdUI");
      const thresholdVal = document.getElementById("thresholdVal");
      const topKHidden = document.getElementById("topKHidden");
      const thresholdHidden = document.getElementById("thresholdHidden");

      function syncControls() {
        if (topKUI && topKHidden)
          topKHidden.value = parseInt(topKUI.value) || 50;
        if (thresholdUI && thresholdHidden)
          thresholdHidden.value = parseFloat(thresholdUI.value) || 0.4;
        if (thresholdVal && thresholdUI)
          thresholdVal.value = parseFloat(thresholdUI.value).toFixed(2);
      }

      if (topKUI) topKUI.addEventListener("input", syncControls);
      if (thresholdUI) thresholdUI.addEventListener("input", syncControls);
      if (thresholdVal)
        thresholdVal.addEventListener("input", function () {
          let v = parseFloat(this.value);
          if (isNaN(v)) v = 0.4;
          v = Math.max(0, Math.min(1, v));
          thresholdUI.value = v;
          syncControls();
        });

      // Initialize sync
      syncControls();

      // Download all images as ZIP
      const downloadAllBtn = document.getElementById("downloadAllBtn");
      function updateDownloadButtonVisibility() {
        // show if results exist on page
        const haveResults =
          document.querySelectorAll(".result-card").length > 0;
        if (downloadAllBtn) {
          downloadAllBtn.classList.toggle("hidden", !haveResults);
        }
      }

      // On initial load (server-rendered results), update visibility
      updateDownloadButtonVisibility();

      if (downloadAllBtn) {
        downloadAllBtn.addEventListener("click", async function () {
          // collect filenames (not URLs) from result-card data-file attributes
          const cards = Array.from(document.querySelectorAll(".result-card"));
          const files = cards.map((c) => c.dataset.file).filter(Boolean);
          if (files.length === 0) {
            alert("No result images to download");
            return;
          }

          // POST to /download_zip and stream the blob as a file download
          try {
            const resp = await fetch("/download_zip", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ files: files }),
            });
            if (!resp.ok) {
              const txt = await resp.text();
              alert("Failed to create ZIP: " + txt);
              return;
            }
            const blob = await resp.blob();
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "results_images.zip";
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
          } catch (err) {
            console.error(err);
            alert("Error downloading ZIP: " + err.message);
          }
        });
      }

      // Modal functionality
      function openModal(imageSrc, filename, score) {
        if (!imageSrc) return;

        document.getElementById("modalImage").src = imageSrc;
        document.getElementById("modalFilename").textContent = filename;
        const scoreEl = document.getElementById("modalScore");
        if (scoreEl) {
          if (isNaN(score)) {
            scoreEl.style.display = "none";
          } else {
            scoreEl.style.display = "block";
            scoreEl.innerHTML = `<i class="fas fa-percentage"></i> ${(
              score * 100
            ).toFixed(1)}% match`;
          }
        }
        document.getElementById("imageModal").style.display = "flex";
        document.body.style.overflow = "hidden";
      }

      function closeModal() {
        document.getElementById("imageModal").style.display = "none";
        document.body.style.overflow = "auto";
      }

      // Close modal on outside click
      document
        .getElementById("imageModal")
        .addEventListener("click", function (e) {
          if (e.target === this) {
            closeModal();
          }
        });

      // Keyboard shortcuts
      document.addEventListener("keydown", function (e) {
        if (e.key === "Escape") {
          closeModal();
          closeCamera();
        }
      });

      // Attach click handlers to result cards (avoid inline onclick attributes)
      document.querySelectorAll(".result-card").forEach(function (el) {
        el.addEventListener("click", function () {
          var path = el.dataset.path || "";
          var file = el.dataset.file || "";
          var score = parseFloat(el.dataset.score) || 0.0;
          openModal(path, file, score);
        });
      });

      // Make server-rendered query preview clickable as well
      const serverQueryImg = document.querySelector(".query-preview img");
      if (serverQueryImg) {
        serverQueryImg.style.cursor = "pointer";
        serverQueryImg.addEventListener("click", function () {
          openModal(serverQueryImg.src, "Query Image", NaN);
        });
      }

      // Selfie / Camera capture logic
      const selfieBtnBig = document.getElementById("selfieBtnBig");
      const cameraModal = document.getElementById("cameraModal");
      const cameraVideo = document.getElementById("cameraVideo");
      const cameraCanvas = document.getElementById("cameraCanvas");
      const captureBtn = document.getElementById("captureBtn");
      const retakeBtn = document.getElementById("retakeBtn");
      const useBtn = document.getElementById("useBtn");
      const cameraClose = document.getElementById("cameraClose");
      let stream = null;

      async function openCamera() {
        try {
          stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: "user" },
            audio: false,
          });
          cameraVideo.srcObject = stream;
          cameraModal.classList.remove("hidden");
          cameraModal.style.display = "flex";
          // reset UI
          cameraVideo.classList.remove("hidden");
          cameraCanvas.classList.add("hidden");
          captureBtn.classList.remove("hidden");
          retakeBtn.classList.add("hidden");
          useBtn.classList.add("hidden");
        } catch (err) {
          alert("Unable to access camera: " + err.message);
        }
      }

      function closeCamera() {
        cameraModal.classList.add("hidden");
        cameraModal.style.display = "none";
        if (stream) {
          stream.getTracks().forEach((t) => t.stop());
          stream = null;
        }
      }

      function dataURLToFile(dataurl, filename) {
        const arr = dataurl.split(",");
        const mimeMatch = arr[0].match(/:(.*?);/);
        if (!mimeMatch) return null;
        const mime = mimeMatch[1];
        const bstr = atob(arr[1]);
        let n = bstr.length;
        const u8arr = new Uint8Array(n);
        while (n--) {
          u8arr[n] = bstr.charCodeAt(n);
        }
        return new File([u8arr], filename, { type: mime });
      }

      if (selfieBtnBig)
        selfieBtnBig.addEventListener("click", function () {
          openCamera();
        });

      if (cameraClose)
        cameraClose.addEventListener("click", function () {
          closeCamera();
        });

      captureBtn.addEventListener("click", function () {
        const vw = cameraVideo.videoWidth;
        const vh = cameraVideo.videoHeight;
        if (!vw || !vh) {
          alert("Camera not ready, try again");
          return;
        }
        cameraCanvas.width = vw;
        cameraCanvas.height = vh;
        const ctx = cameraCanvas.getContext("2d");
        ctx.drawImage(cameraVideo, 0, 0, vw, vh);
        const dataUrl = cameraCanvas.toDataURL("image/jpeg", 0.92);

        // **** START: MODIFIED LOGIC ****
        // Directly use the captured photo as if it were an uploaded file.
        const file = dataURLToFile(dataUrl, "selfie.jpg");
        if (file) {
          // Use DataTransfer to create a FileList
          const dt = new DataTransfer();
          dt.items.add(file);

          const input = document.getElementById("queryImage");
          input.files = dt.files;

          // Manually trigger the 'change' event on the input.
          // This will make our existing preview logic run.
          const ev = new Event("change", { bubbles: true });
          input.dispatchEvent(ev);
        }
        // Now that the file is in the input, close the camera.
        closeCamera();
        // **** END: MODIFIED LOGIC ****
      });

      // This function is now redundant but kept for reference.
      retakeBtn.addEventListener("click", function () {
        cameraVideo.classList.remove("hidden");
        cameraCanvas.classList.add("hidden");
        captureBtn.classList.remove("hidden");
        retakeBtn.classList.add("hidden");
        useBtn.classList.add("hidden");
      });

      // This button is also now redundant.
      useBtn.addEventListener("click", function () {
        // The logic from here has been moved into the captureBtn handler.
      });

      // This function is only needed if you want a separate selfie preview,
      // which we are no longer using to simplify the flow.
      function clearSelfie() {
        // This function is no longer used with the new simplified flow.
        // Kept for reference.
      }

      // close camera modal on outside click
      cameraModal.addEventListener("click", function (e) {
        if (e.target === cameraModal) closeCamera();
      });
    </script>
  </body>
</html>
